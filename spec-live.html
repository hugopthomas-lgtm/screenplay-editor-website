<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>AI Live Formatting Spec — Screenplay Editor</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --violet: #9D7BEA;
      --violet-dark: #8B6AD4;
      --violet-light: #f8f6fc;
      --dark: #1a1a1a;
      --green: #34C759;
      --red: #FF3B30;
      --orange: #FF9500;
    }

    body {
      font-family: 'JetBrains Mono', monospace;
      background: #fafafa;
      color: #1a1a1a;
      line-height: 1.6;
      font-size: 14px;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    /* Header */
    header {
      background: var(--dark);
      padding: 20px 30px;
      border-bottom: 1px solid rgba(157, 123, 234, 0.4);
      background-image:
        linear-gradient(rgba(157, 123, 234, 0.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(157, 123, 234, 0.04) 1px, transparent 1px);
      background-size: 60px 60px;
    }

    .header-content {
      max-width: 1000px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 1px;
      color: var(--violet);
    }

    .header-badge {
      font-size: 11px;
      color: #666;
      background: rgba(157, 123, 234, 0.1);
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid rgba(157, 123, 234, 0.2);
    }

    /* Page Content */
    .page-content {
      max-width: 1000px;
      margin: 0 auto;
      padding: 40px 30px 80px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--dark);
    }

    .page-subtitle {
      font-size: 13px;
      color: #888;
      margin-bottom: 40px;
    }

    .last-updated {
      font-size: 12px;
      color: #888;
      margin-bottom: 40px;
      padding: 8px 12px;
      background: var(--violet-light);
      border-radius: 6px;
      display: inline-block;
    }

    /* Section */
    .section {
      margin-bottom: 50px;
    }

    .section h2 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 20px;
      padding-left: 15px;
      border-left: 3px solid var(--violet);
      color: var(--dark);
    }

    .section p {
      font-size: 13px;
      color: #555;
      line-height: 1.7;
      margin-bottom: 15px;
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-size: 13px;
    }

    th {
      text-align: left;
      padding: 12px 15px;
      background: var(--dark);
      color: #fff;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    th:first-child {
      border-radius: 8px 0 0 0;
    }

    th:last-child {
      border-radius: 0 8px 0 0;
    }

    td {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      color: #444;
    }

    tr:last-child td:first-child {
      border-radius: 0 0 0 8px;
    }

    tr:last-child td:last-child {
      border-radius: 0 0 8px 0;
    }

    tr:hover td {
      background: var(--violet-light);
    }

    .value {
      font-weight: 600;
      color: var(--dark);
    }

    /* Code */
    code {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }

    .code-block {
      background: var(--dark);
      color: #fff;
      padding: 20px;
      border-radius: 8px;
      font-size: 12px;
      overflow-x: auto;
      margin: 15px 0;
    }

    .code-block .comment {
      color: #888;
    }

    .code-block .keyword {
      color: var(--violet);
    }

    .code-block .string {
      color: var(--green);
    }

    /* Info Cards */
    .info-card {
      background: #fff;
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
    }

    .info-card.highlight {
      border-left: 4px solid var(--violet);
      background: var(--violet-light);
    }

    .info-card.warning {
      border-left: 4px solid var(--orange);
      background: #fff9f0;
    }

    .info-card h3 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--dark);
    }

    .info-card p {
      margin-bottom: 0;
    }

    /* Flow diagram */
    .flow {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      margin: 20px 0;
    }

    .flow-step {
      background: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 12px 18px;
      font-size: 12px;
      font-weight: 500;
    }

    .flow-step.active {
      background: var(--violet);
      color: #fff;
      border-color: var(--violet);
    }

    .flow-arrow {
      color: #ccc;
      font-size: 18px;
    }

    /* Detection rules */
    .detection-rule {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .detection-rule:hover {
      border-color: var(--violet);
    }

    .detection-input {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: #666;
      min-width: 200px;
    }

    .detection-arrow {
      color: var(--violet);
      font-weight: bold;
    }

    .detection-output {
      font-weight: 600;
      color: var(--dark);
    }

    /* Comparison table */
    .comparison-table td:first-child {
      font-weight: 600;
      color: var(--dark);
    }

    /* Footer */
    footer {
      background: var(--dark);
      color: #fff;
      padding: 30px;
      text-align: center;
      background-image:
        linear-gradient(rgba(157, 123, 234, 0.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(157, 123, 234, 0.04) 1px, transparent 1px);
      background-size: 60px 60px;
    }

    .footer-text {
      font-size: 12px;
      color: #666;
    }

    .footer-text a {
      color: var(--violet);
    }

    .footer-nav {
      margin-bottom: 15px;
    }

    .footer-nav a {
      color: var(--violet);
      margin: 0 15px;
      font-size: 12px;
    }

    .footer-nav a:hover {
      text-decoration: underline;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .page-content {
        padding: 30px 20px 60px;
      }

      .page-title {
        font-size: 24px;
      }

      .flow {
        flex-direction: column;
        align-items: flex-start;
      }

      .flow-arrow {
        transform: rotate(90deg);
      }

      .detection-rule {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-content">
      <div class="logo">SCR▌ SPEC — AI LIVE</div>
      <div class="header-badge">Internal Documentation</div>
    </div>
  </header>

  <main>
    <div class="page-content">

      <h1 class="page-title">AI Live Formatting</h1>
      <p class="page-subtitle">Real-time formatting as you write. Source of truth.</p>
      <div class="last-updated">Last updated: January 12, 2025 (Pruneau 6)</div>

      <!-- HOW IT WORKS -->
      <div class="section">
        <h2>How It Works</h2>

        <div class="flow">
          <div class="flow-step">User types</div>
          <span class="flow-arrow">→</span>
          <div class="flow-step">Polling every 800ms</div>
          <span class="flow-arrow">→</span>
          <div class="flow-step">Traffic Light OK?</div>
          <span class="flow-arrow">→</span>
          <div class="flow-step active">Format current + previous</div>
        </div>

        <div class="info-card highlight">
          <h3>Stateless Architecture (Pruneau 6)</h3>
          <p>The formatter is now <strong>stateless</strong>: no more PropertiesService, no index tracking. Each poll only looks at the current cursor position and the previous paragraph. This eliminates Request Queueing crashes after ~2 minutes of use.</p>
        </div>

        <table>
          <tr>
            <th>Parameter</th>
            <th>Value</th>
            <th>Notes</th>
          </tr>
          <tr>
            <td>Polling interval</td>
            <td class="value">800ms</td>
            <td>processActiveCursor() called via setInterval</td>
          </tr>
          <tr>
            <td>Scope</td>
            <td class="value">Current + Previous paragraph</td>
            <td>Handles "Enter" key context for dialogue continuation</td>
          </tr>
          <tr>
            <td>AI API calls</td>
            <td class="value">None (Fountain mode)</td>
            <td>Classification is local, rule-based</td>
          </tr>
          <tr>
            <td>State management</td>
            <td class="value">Stateless</td>
            <td>No PropertiesService, no index tracking</td>
          </tr>
        </table>
      </div>

      <!-- CLIENT-SIDE ARCHITECTURE -->
      <div class="section">
        <h2>Client-Side Architecture</h2>

        <p>The client (Sidebar.html) implements two protection patterns to prevent server overload:</p>

        <div class="info-card highlight">
          <h3>Traffic Light Pattern</h3>
          <p><code>fountainPending</code> — If a request is still in flight, skip this polling cycle. Prevents request stacking that caused the "freeze after 2 minutes" bug.</p>
        </div>

        <div class="info-card warning">
          <h3>Circuit Breaker Pattern</h3>
          <p><code>consecutiveErrors</code> — If more than 5 consecutive errors occur, pause one cycle to let the server recover. Resets on success.</p>
        </div>

        <div class="code-block">
<span class="keyword">var</span> fountainPending = <span class="keyword">false</span>;  <span class="comment">// Traffic Light</span>
<span class="keyword">var</span> consecutiveErrors = <span class="number">0</span>;    <span class="comment">// Circuit Breaker</span>

setInterval(<span class="keyword">function</span>() {
  <span class="keyword">if</span> (fountainPending) <span class="keyword">return</span>;      <span class="comment">// Skip if busy</span>
  <span class="keyword">if</span> (consecutiveErrors > <span class="number">5</span>) {     <span class="comment">// Cool down</span>
    consecutiveErrors = <span class="number">0</span>;
    <span class="keyword">return</span>;
  }
  fountainPending = <span class="keyword">true</span>;
  google.script.run
    .withSuccessHandler(<span class="keyword">function</span>() {
      fountainPending = <span class="keyword">false</span>;
      consecutiveErrors = <span class="number">0</span>;
    })
    .withFailureHandler(<span class="keyword">function</span>() {
      fountainPending = <span class="keyword">false</span>;
      consecutiveErrors++;
    })
    .processActiveCursor();
}, <span class="number">800</span>);
        </div>
      </div>

      <!-- DETECTION RULES -->
      <div class="section">
        <h2>Detection Rules (Fountain Mode)</h2>

        <p>Classification is done locally using Fountain-style rules. No AI API is called.</p>

        <div class="detection-rule">
          <span class="detection-input">INT. COFFEE SHOP - DAY</span>
          <span class="detection-arrow">→</span>
          <span class="detection-output">SCENE_HEADING</span>
        </div>

        <div class="detection-rule">
          <span class="detection-input">EXT. PARKING LOT - NIGHT</span>
          <span class="detection-arrow">→</span>
          <span class="detection-output">SCENE_HEADING</span>
        </div>

        <div class="detection-rule">
          <span class="detection-input">=john</span>
          <span class="detection-arrow">→</span>
          <span class="detection-output">CHARACTER</span>
        </div>

        <div class="detection-rule">
          <span class="detection-input">(smiling)</span>
          <span class="detection-arrow">→</span>
          <span class="detection-output">PARENTHETICAL</span>
        </div>

        <div class="detection-rule">
          <span class="detection-input">[after CHARACTER]</span>
          <span class="detection-arrow">→</span>
          <span class="detection-output">DIALOGUE</span>
        </div>

        <div class="detection-rule">
          <span class="detection-input">[anything else]</span>
          <span class="detection-arrow">→</span>
          <span class="detection-output">ACTION</span>
        </div>

        <table>
          <tr>
            <th>Pattern</th>
            <th>Type</th>
            <th>Notes</th>
          </tr>
          <tr>
            <td><code>INT.</code> or <code>EXT.</code> at start</td>
            <td class="value">SCENE_HEADING</td>
            <td>Also INT/EXT, I/E</td>
          </tr>
          <tr>
            <td><code>=</code> at start of line</td>
            <td class="value">CHARACTER</td>
            <td>= is removed, text uppercased</td>
          </tr>
          <tr>
            <td><code>(text)</code> wrapped in parentheses</td>
            <td class="value">PARENTHETICAL</td>
            <td>Must be short (&lt;60 chars)</td>
          </tr>
          <tr>
            <td>After CHARACTER or PARENTHETICAL</td>
            <td class="value">DIALOGUE</td>
            <td>Context-based detection</td>
          </tr>
          <tr>
            <td>Everything else</td>
            <td class="value">ACTION</td>
            <td>Default fallback</td>
          </tr>
        </table>
      </div>

      <!-- THE = PREFIX -->
      <div class="section">
        <h2>The = Prefix (Character Marker)</h2>

        <div class="info-card highlight">
          <h3>How it works</h3>
          <p>Type <code>=paul</code> and when you leave the line, it becomes <code>PAUL</code> formatted as CHARACTER.</p>
        </div>

        <table>
          <tr>
            <th>You type</th>
            <th>Result</th>
          </tr>
          <tr>
            <td><code>=paul</code></td>
            <td class="value">PAUL</td>
          </tr>
          <tr>
            <td><code>=mary jane</code></td>
            <td class="value">MARY JANE</td>
          </tr>
          <tr>
            <td><code>=dr. smith</code></td>
            <td class="value">DR. SMITH</td>
          </tr>
        </table>

        <p>The <code>=</code> prefix is a Fountain convention that forces a line to be treated as a character name, regardless of context.</p>
      </div>

      <!-- CONTEXT -->
      <div class="section">
        <h2>Context Handling (Stateless)</h2>

        <table>
          <tr>
            <th>Function</th>
            <th>Purpose</th>
          </tr>
          <tr>
            <td><code>getSimpleType(para)</code></td>
            <td>Detects type of an ALREADY formatted paragraph by reading its indentation. Returns CHARACTER (≥170pt), DIALOGUE/PARENTHETICAL (≥80pt), or ACTION</td>
          </tr>
          <tr>
            <td><code>determineFountainType(text, contextType)</code></td>
            <td>Determines target type for NEW text based on content patterns and context from previous paragraph</td>
          </tr>
        </table>

        <div class="info-card highlight">
          <h3>Indentation Thresholds</h3>
          <p>Context detection uses indentation values adapted for both US Letter and A4 formats:</p>
          <table>
            <tr>
              <th>Type</th>
              <th>US Indent</th>
              <th>A4 Indent</th>
              <th>Detection Threshold</th>
            </tr>
            <tr>
              <td>CHARACTER</td>
              <td>194pt</td>
              <td>178pt</td>
              <td>≥ 170pt</td>
            </tr>
            <tr>
              <td>PARENTHETICAL</td>
              <td>151pt</td>
              <td>136pt</td>
              <td>≥ 80pt + parentheses</td>
            </tr>
            <tr>
              <td>DIALOGUE</td>
              <td>101pt</td>
              <td>93pt</td>
              <td>≥ 80pt</td>
            </tr>
          </table>
        </div>

        <div class="info-card">
          <h3>Multi-line Dialogue Support</h3>
          <p>When the previous paragraph is DIALOGUE, the next non-empty line continues as DIALOGUE. This allows natural multi-paragraph dialogue without needing <code>=</code> markers for each line.</p>
        </div>
      </div>

      <!-- WHAT GETS MODIFIED -->
      <div class="section">
        <h2>What Gets Modified</h2>

        <table>
          <tr>
            <th>Modification</th>
            <th>AI Live Formatting</th>
            <th>Format my document</th>
          </tr>
          <tr>
            <td>Indentation</td>
            <td class="value">✅ Yes</td>
            <td class="value">✅ Yes</td>
          </tr>
          <tr>
            <td>Alignment</td>
            <td class="value">✅ Yes</td>
            <td class="value">✅ Yes</td>
          </tr>
          <tr>
            <td>Font</td>
            <td class="value">✅ Yes</td>
            <td class="value">✅ Yes</td>
          </tr>
          <tr>
            <td>Remove = prefix</td>
            <td class="value">✅ Yes</td>
            <td class="value">❌ No</td>
          </tr>
          <tr>
            <td>Uppercase CHARACTER</td>
            <td class="value">✅ Yes (with =)</td>
            <td class="value">✅ Yes (all)</td>
          </tr>
          <tr>
            <td>Uppercase SCENE_HEADING</td>
            <td class="value">✅ Yes</td>
            <td class="value">✅ Yes</td>
          </tr>
          <tr>
            <td>Insert empty lines</td>
            <td class="value">❌ No</td>
            <td class="value">✅ Yes</td>
          </tr>
          <tr>
            <td>Remove underline/bold</td>
            <td class="value">❌ No</td>
            <td class="value">✅ Yes</td>
          </tr>
        </table>
      </div>

      <!-- COMPARISON -->
      <div class="section">
        <h2>AI Live vs Format My Document</h2>

        <table class="comparison-table">
          <tr>
            <th>Aspect</th>
            <th>AI Live Formatting</th>
            <th>Format my document</th>
          </tr>
          <tr>
            <td>Trigger</td>
            <td>Automatic (polling 800ms)</td>
            <td>Manual (button click)</td>
          </tr>
          <tr>
            <td>Scope</td>
            <td>Single line (the one you just left)</td>
            <td>Entire document</td>
          </tr>
          <tr>
            <td>AI API</td>
            <td>No (local Fountain rules)</td>
            <td>Yes (Claude for detection)</td>
          </tr>
          <tr>
            <td>Text modification</td>
            <td>Only = removal + uppercase</td>
            <td>Full correction (punctuation, case, merging)</td>
          </tr>
          <tr>
            <td>Empty lines</td>
            <td>Not managed</td>
            <td>Inserted automatically</td>
          </tr>
          <tr>
            <td>Context</td>
            <td>lastType only</td>
            <td>Full document sent to AI</td>
          </tr>
          <tr>
            <td>Best for</td>
            <td>Writing flow, real-time feedback</td>
            <td>Cleaning up existing text, final formatting</td>
          </tr>
        </table>
      </div>

      <!-- TRAPS -->
      <div class="section">
        <h2>⚠️ Traps — Don't Touch</h2>

        <table>
          <tr>
            <th>Never do this</th>
            <th>Why</th>
            <th>Do this instead</th>
          </tr>
          <tr>
            <td>Use <code>PropertiesService</code> for state</td>
            <td><strong>Request Queueing:</strong> PropertiesService is slow (~200ms). With 400ms polling, requests stack up and crash after ~2 minutes</td>
            <td>Go stateless — read context from document on each call</td>
          </tr>
          <tr>
            <td>Send requests without traffic control</td>
            <td>If previous request is still running, new requests pile up → freeze</td>
            <td>Use <code>fountainPending</code> flag to skip cycles</td>
          </tr>
          <tr>
            <td>Call AI API on every poll</td>
            <td>Too slow (800ms + API latency), expensive, rate limits</td>
            <td>Use local Fountain rules, AI only for full document format</td>
          </tr>
          <tr>
            <td>Track paragraph index across calls</td>
            <td><strong>Ghost Context Bug:</strong> Stored index becomes stale when user navigates</td>
            <td>Use <code>getSimpleType(prevPara)</code> to read REAL formatting</td>
          </tr>
        </table>

        <div class="info-card warning">
          <h3>Request Queueing Bug (Fixed Pruneau 6)</h3>
          <p>The old architecture used <code>PropertiesService</code> to track index and context across calls. PropertiesService has ~200ms latency, so with 400ms polling, requests would stack up faster than they could complete. After ~2 minutes, the queue would overflow and freeze the add-on. Solution: <strong>stateless architecture</strong> — no PropertiesService, no index tracking, just read the cursor and previous paragraph on each call.</p>
        </div>
      </div>

      <!-- FILES -->
      <div class="section">
        <h2>Related Files</h2>

        <table>
          <tr>
            <th>File</th>
            <th>Purpose</th>
          </tr>
          <tr>
            <td><code>FountainFormat.js</code></td>
            <td>Server logic: processActiveCursor(), determineFountainType(), getSimpleType(), applyFormatting()</td>
          </tr>
          <tr>
            <td><code>Sidebar.html</code></td>
            <td>Client polling: setInterval(processActiveCursor, 800), fountainPending + consecutiveErrors</td>
          </tr>
          <tr>
            <td><code>Code.js</code></td>
            <td>getStyleAttributes(), getIndents() — shared with "Format my document"</td>
          </tr>
        </table>
      </div>

    </div>
  </main>

  <footer>
    <nav class="footer-nav">
      <a href="spec.html">Format Spec</a>
      <a href="docs.html">All Docs</a>
      <a href="index.html">Back to site</a>
    </nav>
    <p class="footer-text">Screenplay Editor — Internal Spec</p>
  </footer>
</body>
</html>
